# Reference documentation about workflow syntax: https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions#defaultsrun
# Building and testing Powershell guide: https://docs.github.com/en/actions/guides/building-and-testing-powershell

# Jobs are run in parallel, unless a 'needs' condition is specified
# Steps are always run sequentially

name: CI/CD-test
on: [push]
jobs:
  # Test: perform some code quality test before building
  Test:
    runs-on: windows-latest
    steps:
      # Make your repo available to workflow: https://github.com/actions/checkout
      - name: Check out repository code
        uses: actions/checkout@v2
      # Install InvokeBuild if not present
      - name: Install InvokeBuild module on the runner
        run: |
          if (-not (Get-Module -Name InvokeBuild -ListAvailable)) {
            Install-Module InvokeBuild -Scope CurrentUser -Force
          }
          Import-Module InvokeBuild
      # Analyze code with PSScriptAnalyzer
      - name: Analyze code with PSScriptAnalyzer
        run: |
          Invoke-Build -Task Analyze
      # Upload analysis results in build folder
      - name: Upload analysis results
        uses: actions/upload-artifact@v2
        with:
          name: windows-script-analyzer
          path: ${{ github.workspace }}/build/tests.xml
      if: ${{ always() }} # Publish even if the tests fail       